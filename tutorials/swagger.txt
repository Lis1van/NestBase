### **Руководство по генерации документации Swagger и созданию модулей в NestJS**

---

#### **Краткий обзор предыдущего урока**

В предыдущем уроке мы разобрали процесс создания REST API с использованием NestJS CLI и посмотрели,
как автоматически интегрируются новые модули в главный `AppModule`. Основное внимание было уделено
настройке CRUD-операций с помощью методов контроллера и использованию встроенных возможностей NestJS для
организации кода.

---

### **1. Документация Swagger и её значение**

Swagger — это мощный инструмент для автоматического создания документации к API на основе аннотаций кода.
Используя Swagger, можно динамически генерировать документацию, что позволяет разработчикам и клиентам видеть
текущие API-эндпоинты и их параметры, проверять их и тестировать без написания отдельной документации.
Кроме того, поддержка Swagger в NestJS позволяет легко интегрировать этот инструмент в проект,
добавляя минимальные изменения в структуру кода.

---

### **2. Установка модуля Swagger**

Чтобы начать работу со Swagger, установите необходимый пакет:

```bash
npm install --save @nestjs/swagger
```

Эта команда добавит в проект пакет `@nestjs/swagger`, обеспечивающий связь между NestJS и Swagger и
позволяющий использовать различные декораторы для описания моделей данных и методов API.

> **Пояснение:** Установка `@nestjs/swagger` даёт возможность добавлять декораторы в классы и методы,
которые Swagger будет использовать для генерации документации. Эта установка обязательна для корректной
интеграции Swagger.

---

### **3. Конфигурация Swagger в `main.ts`**

После установки пакета необходимо добавить настройки для Swagger в главный файл приложения, обычно это `main.ts`.
Здесь мы определяем конфигурацию для Swagger, используя `DocumentBuilder` и настраиваем базовую информацию,
такую как название и версию API.

#### Пример: Настройка Swagger в `main.ts`

```typescript
// main.ts
import { NestFactory } from '@nestjs/core';
import { DocumentBuilder, SwaggerModule } from '@nestjs/swagger';
import { AppModule } from './app.module';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);

  // Настройка конфигурации Swagger
  const config = new DocumentBuilder()
    .setTitle('Пример API для приложения')
    .setDescription('Документация для API, работающего с сущностью пользователя')
    .setVersion('1.0')
    .addBearerAuth({
      in: 'header',
      type: 'http',
      scheme: 'bearer',
      bearerFormat: 'JWT',
    }) // Подключаем авторизацию через Bearer токен
    .build();

  const document = SwaggerModule.createDocument(app, config);

  // Подключение Swagger на адрес /api
  SwaggerModule.setup('api', app, document, {
    swaggerOptions: {
      docExpansion: 'list',
      defaultModelsExpandDepth: 1,
      persistAuthorization: true, // Сохраняет авторизацию при перезагрузке страницы
    },
  });

  await app.listen(3000);
}
bootstrap();
```

> **Пояснение:** Конфигурация Swagger начинается с создания объекта `config` через `DocumentBuilder`,
где указываются основные параметры, такие как заголовок API, описание и версия. Эти данные затем используются
для генерации документации с помощью `SwaggerModule.createDocument`.

Для более подробного изучения возможностей Swagger можно ознакомиться с [официальной документацией NestJS по
Swagger](https://docs.nestjs.com/openapi/introduction).

---

### **4. Запуск и проверка документации**

Теперь, после добавления конфигурации, при запуске приложения командой `npm run start:dev` документация будет
доступна по адресу [http://localhost:3000/api](http://localhost:3000/api).

Swagger автоматически сгенерирует интерфейс документации, позволяющий просматривать все эндпоинты,
отправлять запросы и видеть их параметры.

---

### **5. Подключение Swagger к контроллеру**

Swagger требует описания данных, передаваемых в запросах, чтобы корректно отображать их в документации.
Например, для создания нового пользователя можно добавить DTO (Data Transfer Object) и использовать
декораторы `@ApiProperty` для описания полей.

#### Пример: DTO для создания пользователя

```typescript
// create-user.dto.ts
import { ApiProperty } from '@nestjs/swagger';

export class CreateUserDto {
  @ApiProperty({ description: 'Имя пользователя', default: 'Ivan' })
  name: string;

  @ApiProperty({
    description: 'Электронная почта пользователя',
    default: 'ivan@gmail.com',
  })
  email: string;

  @ApiProperty({ description: 'Пароль пользователя', minLength: 8 })
  password: string;
}
```

> **Пояснение:** В этом примере каждое поле DTO описано с помощью `@ApiProperty`, где указаны описание,
значение по умолчанию, а также можно добавить ограничения, например, `minLength` или `required`. Swagger автоматически использует эти описания для генерации формы с полями при создании нового пользователя.

### **6. Подключение DTO к контроллеру**

Чтобы Swagger отобразил DTO в документации для метода создания пользователя, необходимо связать DTO с
маршрутом в контроллере.

```typescript
// users.controller.ts
import { Controller, Post, Body } from '@nestjs/common';
import { ApiTags } from '@nestjs/swagger';
import { CreateUserDto } from './dto/create-user.dto';
import { UsersService } from './users.service';

@ApiTags('users') // Указываем тег для группировки маршрутов
@Controller('users')
export class UsersController {
  constructor(private readonly usersService: UsersService) {}

  @Post()
  create(@Body() createUserDto: CreateUserDto) {
    return this.usersService.create(createUserDto);
  }
}
```

> **Примечание:** Использование `@ApiTags` позволяет группировать все эндпоинты контроллера под одним
тегом `users`. Это помогает организовать документацию, делая её более понятной и доступной.

---

### **7. Параметры `@ApiProperty` и другие декораторы Swagger**

Декоратор `@ApiProperty` поддерживает ряд параметров, таких как `description` (описание поля),
`default` (значение по умолчанию), `required` (обязательность поля), `minLength` и
`maxLength` (ограничения на длину строки). Эти параметры позволяют гибко настроить отображение полей в документации.

Кроме того, доступны и другие декораторы Swagger для параметров, запросов и ответов:

- **@ApiQuery**: для описания параметров запроса
- **@ApiResponse**: для описания структуры ответов
- **@ApiParam**: для описания параметров пути
- **@ApiBearerAuth**: для авторизации через Bearer токен

> **Примечание:** Использование этих декораторов позволяет создать детализированную документацию,
в которой указаны все параметры запросов и структурированные ответы, что делает документацию API полноценной и понятной.

---

### **8. Обход использования `@ApiProperty` и автоматизация создания документации**

Чтобы не добавлять `@ApiProperty` вручную к каждому DTO, можно использовать плагин Swagger,
который автоматически добавляет свойства в документацию. Для этого добавьте следующий фрагмент в файл `nest-cli.json`:

```json
{
  "compilerOptions": {
    "plugins": ["@nestjs/swagger"]
  }
}
```

> **Пояснение:** С использованием этого плагина Swagger автоматически обнаруживает все поля DTO и добавляет
их в документацию, что значительно упрощает разработку и поддержание кода.

---

### **9. Дополнительные настройки в `swaggerOptions`**

Помимо основных параметров, Swagger поддерживает различные настройки в `swaggerOptions`,
которые влияют на поведение и отображение документации:

- **docExpansion**: устанавливает, как раскрывать секции документации (`none`, `list`, `full`)
- **defaultModelsExpandDepth**: указывает глубину отображения вложенных моделей
- **persistAuthorization**: сохраняет авторизацию после перезагрузки страницы (удобно при тестировании)

Пример:

```typescript
SwaggerModule.setup('api', app, document, {
  swaggerOptions: {
    docExpansion: 'none',
    persistAuthorization: true,
  },
});
```

---

### **Заключение**

На этом уроке мы настроили Swagger для автоматической генерации документации, узнали, как добавить
 описание к DTO и контроллерам, а также изучили расширенные параметры Swagger. Этот процесс документирования
 не только упрощает работу с API, но и улучшает взаимодействие с клиентами и тестирование.

> Дополнительную информацию можно найти в [официальной документации NestJS Swagger](https://docs.nestjs.com/openapi/introduction).
